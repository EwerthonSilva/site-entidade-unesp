tinymce.PluginManager.add("dbo_column_manager", function(editor, url) {

	editor.on('init', function(){

		editor.on( 'keydown', function( event ) {
			var node, column, row, P, spacer,
				selection = editor.selection,
				keyCode = event.keyCode,
				dom = editor.dom,
				VK = tinymce.util.VK;

			if ( keyCode === VK.ENTER ) {
				// When pressing Enter inside a caption move the caret to a new parapraph under it
				node = selection.getNode();
				column = dom.getParent( node, 'div.columns' );

				if (column) {

					//checando agora se o prev é um paragrafo em branco
					prv = dom.getPrev(node, 'p');

					if(dom.isEmpty(prv)){
						dom.events.cancel( event ); // Doesn't cancel all :(

						spacer = tinymce.Env.ie && tinymce.Env.ie < 11 ? '' : '<br data-mce-bogus="1" />';
						P = dom.create( 'p', null, spacer );

						// Remove any extra dt and dd cleated on pressing Enter...
						tinymce.each( dom.select( 'p' ), function( element ) {
							if ( dom.isEmpty( element ) && dom.getParent(element, 'div.columns') ) {
								dom.remove( element );
							}
						});

						row = dom.getParent(column, 'div.row');

						editor.dom.insertAfter( P, row );

						editor.nodeChanged();
						selection.setCursorLocation( P, 0 );
					}
				}
			}
		});


		/*//testando select
		editor.on('click', function(e){
			var parent;

			if ( e.target.nodeName == 'IMG' && ( parent = editor.dom.getParent(e.target, 'dl') ) ) {
				e.preventDefault();
				editor.selection.select(parent);
			}
		})

		editor.on('keypress', function(e){
			if ( e.target.nodeName == 'IMG' && ( parent = editor.dom.getParent(e.target, 'dl') ) ) {
				e.preventDefault();
			}
			console.log(e.keyCode);

		})*/
	})

	editor.addButton("dbo_column_manager", {
        icon: "template",
		tooltip: "Inserir colunas",
        onclick: function() {
            editor.windowManager.open({
				//width: Math.min(Math.max(document.documentElement.clientWidth, window.innerWidth || 0) - 30, 1200),
				//height: Math.min(Math.max(document.documentElement.clientHeight, window.innerHeight || 0) - 30, 700),
				width: Math.min(Math.max(document.documentElement.clientWidth, window.innerWidth || 0) - 30, 450),
				height: Math.min(Math.max(document.documentElement.clientHeight, window.innerHeight || 0) - 30, 300),
                title: "Assistente de criação de colunas",
				file: DBO_URL + "/../dbo-column-manager.php?dbo_modal=1"
                /*onsubmit: function(b) {
                    editor.insertContent("Title: " + b.dateditor.title)
                }*/
            })
        }
    })

});