tinymce.PluginManager.add("dbo_media_manager", function(editor, url) {

	editor.on('init', function(){

		editor.on( 'keydown', function( event ) {
			var node, wrap, P, spacer,
				selection = editor.selection,
				keyCode = event.keyCode,
				dom = editor.dom,
				VK = tinymce.util.VK;

			if ( keyCode === VK.ENTER ) {
				// When pressing Enter inside a caption move the caret to a new parapraph under it
				node = selection.getNode();
				wrap = dom.getParent( node, 'div[media-manager-element="image-container"]' );

				if (wrap) {

					dom.events.cancel( event ); // Doesn't cancel all :(

					spacer = tinymce.Env.ie && tinymce.Env.ie < 11 ? '' : '<br data-mce-bogus="1" />';
					P = dom.create( 'p', null, spacer );

					editor.dom.insertAfter( P, wrap );

					// Remove any extra dt and dd cleated on pressing Enter...
					tinymce.each( dom.select( 'dl, dt, dd, div[media-manager-element]' ), function( element ) {
						if ( dom.isEmpty( element ) ) {
							dom.remove( element );
						}
					});

					editor.nodeChanged();
					selection.setCursorLocation( P, 0 );
				}
			} else if ( keyCode === VK.DELETE || keyCode === VK.BACKSPACE ) {
				node = selection.getNode();

				if ( node.nodeName === 'DT') {
					wrap = dom.getParent( node, 'div[media-manager-element="image-container"]' );
				} 

				if ( wrap ) {
					console.log(wrap);
					dom.events.cancel( event );
					dom.remove(wrap);
					editor.nodeChanged();
					return false;
				}
			}
		});


		/*//testando select
		editor.on('click', function(e){
			var parent;

			if ( e.target.nodeName == 'IMG' && ( parent = editor.dom.getParent(e.target, 'dl') ) ) {
				e.preventDefault();
				editor.selection.select(parent);
			}
		})

		editor.on('keypress', function(e){
			if ( e.target.nodeName == 'IMG' && ( parent = editor.dom.getParent(e.target, 'dl') ) ) {
				e.preventDefault();
			}
			console.log(e.keyCode);

		})*/
	})

	editor.addButton("dbo_media_manager", {
        icon: "image",
		tooltip: "Inserir imagem",
        onclick: function() {
            editor.windowManager.open({
				width: Math.min((Math.max(document.documentElement.clientWidth, window.innerWidth || 0) - 50) - 30, 1920),
				height: Math.min((Math.max(document.documentElement.clientHeight, window.innerHeight || 0) - 50) - 30, 1080),
                title: "Gerenciador de imagens",
				file: DBO_URL + "/../dbo-media-manager.php?dbo_modal=1&destiny=tinymce"
                /*onsubmit: function(b) {
                    editor.insertContent("Title: " + b.dateditor.title)
                }*/
            })
        }
    })

});